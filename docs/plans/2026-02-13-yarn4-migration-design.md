# Yarn 4 Migration Design

**Date:** 2026-02-13
**Status:** Approved
**Approach:** Clean Slate Migration (node_modules mode)

## Overview

Migrate the contribfest Next.js project from npm to Yarn 4 using node_modules mode for maximum compatibility.

## Context

- **Current state:** Next.js 15.1.6 project using npm with package-lock.json
- **Goal:** Migrate to Yarn 4 for improved performance and dependency resolution
- **Constraints:** Use node_modules mode (not PnP) for tool compatibility, no zero-installs

## Design Decisions

### Installation Mode
**Decision:** Use node_modules mode instead of Plug'n'Play (PnP)
**Rationale:** Maximum compatibility with all tools and workflows. While Next.js 15 supports PnP, node_modules mode eliminates any potential compatibility issues.

### Zero-Installs
**Decision:** Do not use zero-installs
**Rationale:** Keep repository size small by not committing `.yarn/cache`. Team members will run `yarn install` as usual.

### Package Manager Pinning
**Decision:** Pin Yarn version via `packageManager` field in package.json
**Rationale:** Ensures consistent Yarn version across all environments using Corepack.

## Migration Process

### Step 1: Enable Yarn via Corepack
- Enable Corepack (Node's built-in package manager manager)
- Add `packageManager` field to package.json to pin Yarn 4.x

### Step 2: Remove npm Artifacts
- Delete `package-lock.json`
- Delete `node_modules/` directory

### Step 3: Configure Yarn for node_modules Mode
- Create `.yarnrc.yml` with:
  - `nodeLinker: node-modules` (use traditional node_modules)
  - `enableGlobalCache: false` (project-local cache)
  - Optional: `compressionLevel: mixed` (faster installs)

### Step 4: Install Dependencies
- Run `yarn install` to generate `yarn.lock` and populate node_modules

### Step 5: Verify Functionality
- Test `yarn dev` (development server)
- Test `yarn build` (production build)
- Test `yarn lint` (linting)

### Step 6: Update Git
- Add Yarn files to git (.yarnrc.yml, yarn.lock, .yarn/releases if present)
- Remove package-lock.json from git
- Update .gitignore for Yarn-specific files

## Configuration Files

### New Files

**`.yarnrc.yml`**
```yaml
nodeLinker: node-modules
enableGlobalCache: false
compressionLevel: mixed
```

**`yarn.lock`**
- Yarn's lockfile (replaces package-lock.json)
- Tracks exact dependency versions

**`.yarn/install-state.gz`**
- Installation state tracking
- Speeds up subsequent installs

### Modified Files

**`package.json`**
- Add: `"packageManager": "yarn@4.x.x"` field

**`.gitignore`**
- Add Yarn-specific entries:
  ```
  # Yarn
  .yarn/*
  !.yarn/patches
  !.yarn/plugins
  !.yarn/releases
  !.yarn/sdks
  !.yarn/versions
  .pnp.*
  ```

### Deleted Files

- `package-lock.json` (no longer needed)
- `node_modules/` (will be regenerated by Yarn)

## Developer Workflow Changes

### What Stays the Same
- All npm scripts work identically (`yarn dev`, `yarn build`, etc.)
- Package names and versions unchanged
- Project structure and code untouched

### What Changes

| npm command | yarn command |
|-------------|--------------|
| `npm install` | `yarn install` or `yarn` |
| `npm install <pkg>` | `yarn add <pkg>` |
| `npm uninstall <pkg>` | `yarn remove <pkg>` |
| `npm run <script>` | `yarn <script>` |

### First-Time Setup for Team Members
1. One-time: `corepack enable` (enables Yarn via Node's Corepack)
2. Then: `yarn install` as usual

### Benefits
- Faster installs (Yarn 4 performance improvements)
- Better dependency resolution
- More reliable lockfile
- Cleaner console output

## Verification & Testing

### Post-Migration Checks

1. **Dependencies installed correctly:**
   - `node_modules/` exists and is populated
   - `yarn.lock` is present and valid
   - All expected packages are present

2. **All scripts work:**
   - `yarn dev` - Development server starts
   - `yarn build` - Production build completes
   - `yarn lint` - Linting runs successfully

3. **TypeScript resolution works:**
   - No module resolution errors
   - Type definitions found correctly
   - IDE/editor IntelliSense works

4. **Git state is clean:**
   - Old npm files removed from tracking
   - New Yarn files added to git
   - `.gitignore` properly configured

### Rollback Plan

If something goes wrong:
1. `git checkout package-lock.json`
2. `rm -rf node_modules yarn.lock .yarn .yarnrc.yml`
3. `npm install`

## Timeline

This is a straightforward migration that can be completed in a single session:
- Migration: ~10 minutes
- Testing: ~5 minutes
- Git cleanup: ~5 minutes

## Success Criteria

- [ ] Yarn 4 installed and configured
- [ ] All dependencies install successfully
- [ ] All npm scripts work with yarn
- [ ] Development server runs
- [ ] Production build succeeds
- [ ] Linting passes
- [ ] Git tracking updated correctly
- [ ] No npm artifacts remain

## Future Considerations

- **Yarn Plugins:** Can add plugins later if needed (typescript, interactive-tools, workspace-tools)
- **Workspace Support:** If project becomes a monorepo, Yarn 4 has excellent workspace support
- **PnP Migration:** Could migrate to PnP mode later if desired for additional performance benefits
